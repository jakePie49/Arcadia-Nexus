<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFS v3.0: Isometric Social Engine</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body { background-color: #000; color: #e5e5e5; font-family: 'VT323', monospace; overflow: hidden; }
        .pixel-font { font-family: 'Press Start 2P', cursive; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Isometric Projection */
        .iso-grid {
            display: grid;
            gap: 2px;
            transform: scale(1.5) perspective(600px) rotateX(20deg);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const API_KEY = ""; // Environment will inject key here

    // --- LOGIC BIBLE: SCENARIOS ---
    const SCENARIOS = {
      zero_g_heist: {
        id: "zero_g_heist",
        title: "ZERO-G HEIST",
        context: "Oxygen at 4%. High-frequency alarms screaming. Station integrity compromised.",
        user_goal: "Convince the target to cut the tether so you can reach the override valve.",
        npc_goal: "Maintain physical lock to avoid void-drift.",
        environmental_static: 95,
        map_color: "bg-slate-900",
        wall_color: "bg-slate-700"
      },
      neon_extraction: {
        id: "neon_extraction",
        title: "NEON EXTRACTION",
        context: "Deafening club bass. Visual strobe interference. Target is in a neural-sync.",
        user_goal: "Initiate extraction sequence immediately.",
        npc_goal: "Preserve the neural link until the data packet is 100% verified.",
        environmental_static: 85,
        map_color: "bg-fuchsia-950",
        wall_color: "bg-fuchsia-900"
      },
      void_council: {
        id: "void_council",
        title: "VOID COUNCIL",
        context: "Infinite white space. Silence that generates internal tinnitus.",
        user_goal: "Extract coordinate data for the next jump.",
        npc_goal: "Measure your processing speed and emotional stability via cryptic stalling.",
        environmental_static: 5,
        map_color: "bg-zinc-900",
        wall_color: "bg-zinc-800"
      }
    };

    // --- LOGIC BIBLE: ARCHETYPES ---
    const ARCHETYPES = {
      glitch: {
        id: "glitch", name: "GLITCH_CORE",
        desc: "MAX_AROUSAL | SENSORY_LEAK",
        color: "text-yellow-400", border: "border-yellow-500", icon: "ðŸ“»",
        dials: { high_context: 10, formality: 5, intensity: 95, rsd: 30 },
        hook: "OXY-LOW. WHY-STILL-LINKED? TETHER-STABLE. VALVE-DISTANT. DO-NOT-DISCONNECT!"
      },
      sovereign: {
        id: "sovereign", name: "SOVEREIGN_LOGIC",
        desc: "MAX_FORMALITY | HIGH_CONTEXT",
        color: "text-purple-400", border: "border-purple-500", icon: "ðŸ‘‘",
        dials: { high_context: 95, formality: 95, intensity: 20, rsd: 80 },
        hook: "You approach the archive as if your presence is requested. Why do you disturb this equilibrium?"
      },
      fortress: {
        id: "fortress", name: "FORTRESS_VALVE",
        desc: "MAX_RSD | SUBTEXT_VIGILANCE",
        color: "text-red-500", border: "border-red-500", icon: "ðŸ›¡ï¸",
        dials: { high_context: 90, formality: 80, intensity: 15, rsd: 95 },
        hook: "The current vector is sufficient. A change would be... disruptive. Why do you want to alter it?"
      }
    };

    const TONE_COSTS = { NEUTRAL: 5, REASSURING: 12, APOLOGETIC: 18, VULNERABLE: 28, DIRECT: 8, FIRM: 22, URGENT: 15 };
    const TILE_SIZE = 48;
    const GRID_W = 11;
    const GRID_H = 9;

    // Map: 1=Wall, 0=Floor, 2=NPC, 3=Player
    const BASE_MAP = [
      [1,1,1,1,1,1,1,1,1,1,1],
      [1,0,0,0,0,0,0,0,0,0,1],
      [1,0,0,0,1,1,0,0,0,0,1],
      [1,0,0,0,1,1,0,0,0,0,1],
      [1,0,0,0,0,0,0,1,0,0,1],
      [1,0,0,0,0,0,2,1,0,0,1],
      [1,0,0,0,0,0,0,0,0,0,1],
      [1,1,1,1,1,1,1,1,1,1,1]
    ];

    // --- AI BRIDGE ---
    const callGemini = async (prompt, sys) => {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        try {
            const res = await fetch(url, { method: 'POST', body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: sys }] }
            })});
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text;
        } catch (e) { return "ERROR: Connection severed."; }
    };

    // --- APP COMPONENT ---
    function App() {
        const [phase, setPhase] = useState('SPLASH'); 
        const [activeScenario, setActiveScenario] = useState(null);
        const [activeNpc, setActiveNpc] = useState(null);
        const [chat, setChat] = useState([]);
        const [reserve, setReserve] = useState(100);
        const [resolution, setResolution] = useState(0); 
        const [isProcessing, setIsProcessing] = useState(false);
        const [debugMode, setDebugMode] = useState(false);
        const [playerPos, setPlayerPos] = useState({x: 1, y: 1});
        const [npcPos, setNpcPos] = useState({x: 6, y: 5});
        const chatEndRef = useRef(null);

        // Movement Logic
        useEffect(() => {
            const handleKeyDown = (e) => {
                if (e.key === '`') setDebugMode(prev => !prev);
                if (phase === 'ROAM') {
                    let dx = 0, dy = 0;
                    if (e.key === 'ArrowUp' || e.key === 'w') dy = -1;
                    if (e.key === 'ArrowDown' || e.key === 's') dy = 1;
                    if (e.key === 'ArrowLeft' || e.key === 'a') dx = -1;
                    if (e.key === 'ArrowRight' || e.key === 'd') dx = 1;
                    
                    if (e.key === ' ' || e.key === 'Enter') { checkInteraction(); return; }
                    
                    if (dx !== 0 || dy !== 0) {
                        const nx = playerPos.x + dx;
                        const ny = playerPos.y + dy;
                        if (BASE_MAP[ny] && BASE_MAP[ny][nx] !== 1 && !(nx === npcPos.x && ny === npcPos.y)) {
                            setPlayerPos({ x: nx, y: ny });
                        }
                    }
                }
            };
            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
        }, [phase, playerPos, npcPos]);

        useEffect(() => {
            if (chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
        }, [chat]);

        const checkInteraction = () => {
            const dist = Math.abs(playerPos.x - npcPos.x) + Math.abs(playerPos.y - npcPos.y);
            if (dist === 1) {
                setPhase('SIM');
                if (chat.length === 0) setChat([{ role: 'npc', text: activeNpc.hook }]);
            }
        };

        const submitTurn = async (e) => {
            e.preventDefault();
            const text = e.target.userInput.value;
            const tone = e.target.tone.value;
            if (!text || isProcessing) return;
            setIsProcessing(true);
            e.target.userInput.value = "";

            // 1. Math (Drain)
            const contextDelta = Math.abs(15 - activeNpc.dials.high_context);
            const drain = Math.round((TONE_COSTS[tone] + (contextDelta * 0.4) + (activeScenario.environmental_static / 4)));
            setReserve(prev => Math.max(0, prev - drain));
            setChat(prev => [...prev, { role: 'user', text, tone, drain }]);

            // 2. AI (Response)
            const sys = `
                SCENARIO: ${activeScenario.context}
                USER_GOAL: ${activeScenario.user_goal}
                NPC: ${activeNpc.name}. ${activeNpc.desc}.
                NPC_DIALS: RSD=${activeNpc.dials.rsd}, Context=${activeNpc.dials.high_context}.
                User said: "${text}" (Tone: ${tone}).
                Respond in character. If Context Dial > 80, be vague.
                Return JSON: {"reply": "...", "progress": number(0-25)}
            `;
            
            const rawResult = await callGemini(text, sys);
            try {
                const data = JSON.parse(rawResult.match(/\{.*\}/s)[0]);
                setChat(prev => [...prev, { role: 'npc', text: data.reply }]);
                setResolution(prev => Math.min(100, prev + data.progress));
            } catch (e) {
                setChat(prev => [...prev, { role: 'npc', text: "[ERROR]: Signal corruption. Repeat." }]);
            }
            setIsProcessing(false);
            if (resolution >= 100 || reserve <= 0) setPhase('SUMMARY');
        };

        // --- RENDERERS ---
        if (phase === 'SPLASH') return (
            <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center bg-black text-white">
                <h1 className="text-8xl font-black italic text-blue-600 mb-8 tracking-tighter">SFS_v3.0</h1>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-4xl">
                    {Object.values(SCENARIOS).map(s => (
                        <button key={s.id} onClick={() => { setActiveScenario(s); setPhase('SETUP'); }} className="p-8 border-2 border-zinc-800 bg-zinc-950 hover:border-blue-500 text-left transition-all">
                            <h3 className="text-2xl font-bold mb-2 uppercase">{s.title}</h3>
                            <p className="text-xs text-zinc-500">{s.context}</p>
                        </button>
                    ))}
                </div>
            </div>
        );

        if (phase === 'SETUP') return (
            <div className="max-w-6xl mx-auto py-24 px-8 min-h-screen text-white bg-black uppercase">
                <header className="border-b-2 border-zinc-900 pb-12 mb-12">
                    <h1 className="text-6xl font-black italic text-blue-600">Select_Target</h1>
                </header>
                <div className="grid grid-cols-3 gap-8">
                    {Object.values(ARCHETYPES).map(npc => (
                        <button key={npc.id} onClick={() => { setActiveNpc(npc); setPhase('ROAM'); }} className={`p-8 border-2 ${npc.border} bg-zinc-950 hover:bg-black transition-all text-left`}>
                            <div className="text-4xl mb-4">{npc.icon}</div>
                            <h3 className={`text-xl font-bold ${npc.color} mb-2`}>{npc.name}</h3>
                            <p className="text-[0.6rem] text-zinc-500 font-bold">{npc.desc}</p>
                        </button>
                    ))}
                </div>
            </div>
        );

        if (phase === 'ROAM') return (
            <div className={`h-screen ${activeScenario.map_color} flex items-center justify-center relative overflow-hidden text-white`}>
                {/* HUD */}
                <div className="absolute top-8 left-8 bg-black/90 p-6 border-2 border-zinc-800 z-50">
                    <div className="text-blue-500 font-bold tracking-widest text-xs mb-2">{activeScenario.title}</div>
                    <div className="text-[0.6rem] text-zinc-600">
                        <p>TARGET: {activeNpc.name}</p>
                        <p>STATIC: {activeScenario.environmental_static}%</p>
                    </div>
                    <div className="mt-4 pt-4 border-t border-zinc-800 text-[0.5rem] text-zinc-500">
                        WASD to Move | SPACE to Interact
                    </div>
                </div>

                {/* GRID */}
                <div className="iso-grid" style={{ gridTemplateColumns: `repeat(${GRID_W}, ${TILE_SIZE}px)` }}>
                    {BASE_MAP.map((row, y) => row.map((cell, x) => {
                        let cellClass = `w-[${TILE_SIZE}px] h-[${TILE_SIZE}px] flex items-center justify-center transition-all duration-200 `;
                        
                        if (cell === 1) cellClass += activeScenario.wall_color + " shadow-xl border-t border-white/10";
                        else cellClass += "bg-black/40 border border-white/5";

                        let content = null;
                        if (x === playerPos.x && y === playerPos.y) {
                            content = <div className="text-2xl animate-pulse">ðŸ‘¤</div>; // Player
                            cellClass += " bg-blue-900/40 border-blue-500/50";
                        } else if (x === npcPos.x && y === npcPos.y) {
                            content = <div className="text-2xl">{activeNpc.icon}</div>; // NPC
                        }

                        return <div key={`${x}-${y}`} className={cellClass}>{content}</div>;
                    }))}
                </div>
            </div>
        );

        if (phase === 'SIM') return (
            <div className="flex h-screen bg-black text-white font-mono uppercase">
                {/* HUD Sidebar */}
                <div className="w-80 border-r border-zinc-900 p-8 flex flex-col justify-between bg-zinc-950/20">
                    <div>
                        <div className="mb-8 border-b border-zinc-900 pb-8">
                            <p className="text-[0.6rem] text-zinc-500 font-bold tracking-widest mb-2">TARGET_GOAL</p>
                            <p className="text-xs italic text-zinc-400 leading-relaxed lowercase">"{activeScenario.user_goal}"</p>
                        </div>
                        <p className="text-[0.6rem] text-zinc-500 tracking-widest mb-2 font-bold">RESERVE</p>
                        <div className="text-6xl font-black mb-2 tracking-tighter">{reserve}%</div>
                        <div className="h-2 bg-zinc-900 overflow-hidden border border-zinc-700">
                            <div className={`h-full transition-all duration-500 ${reserve < 20 ? 'bg-red-600' : 'bg-green-500'}`} style={{width: `${reserve}%`}}></div>
                        </div>
                    </div>
                    <button onClick={() => setPhase('ROAM')} className="text-xs text-zinc-600 underline hover:text-white">BREAK_LINK</button>
                </div>

                {/* Chat Interface */}
                <main className="flex-1 flex flex-col relative">
                    <header className="p-8 border-b border-zinc-900 flex justify-between items-center z-10 bg-black/90 backdrop-blur">
                        <div className="flex items-center gap-4">
                            <div className={`text-4xl`}>{activeNpc.icon}</div>
                            <div>
                                <h2 className={`text-2xl font-black ${activeNpc.color} italic tracking-tighter`}>{activeNpc.name}</h2>
                                <p className="text-[0.5rem] text-zinc-600 font-bold tracking-widest">{activeNpc.desc}</p>
                            </div>
                        </div>
                        <div className="text-right">
                             <p className="text-[0.6rem] text-zinc-500 font-bold tracking-widest">RESOLUTION</p>
                             <p className="text-2xl font-black text-blue-500">{resolution}%</p>
                        </div>
                    </header>

                    <div className="flex-1 overflow-y-auto p-8 space-y-6 z-10 scroll-hide">
                        {chat.map((msg, i) => (
                            <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} fade-in`}>
                                <div className={`max-w-[85%] p-6 border-l-4 ${msg.role === 'user' ? 'bg-zinc-900 border-blue-600 text-right' : 'bg-zinc-950 border-zinc-700'}`}>
                                    <p className="text-lg normal-case font-serif text-zinc-300 leading-relaxed">{msg.text}</p>
                                    {msg.role === 'user' && <p className="text-[0.5rem] text-blue-500 mt-2 tracking-widest">TONE: {msg.tone} | DRAIN: {msg.drain}</p>}
                                </div>
                            </div>
                        ))}
                        <div ref={chatEndRef}></div>
                        {isProcessing && <div className="text-zinc-700 text-[0.6rem] animate-pulse px-4 tracking-widest text-center">NEURAL_PROCESSING...</div>}
                    </div>

                    <form onSubmit={submitTurn} className="p-6 bg-zinc-950 border-t border-zinc-900 z-10">
                        <div className="flex gap-4">
                            <select name="tone" className="bg-black border border-zinc-800 text-xs text-white p-4 w-40 focus:border-blue-500 outline-none font-bold cursor-pointer">
                                {Object.keys(TONE_COSTS).map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                            <input name="userInput" autoComplete="off" className="flex-1 bg-black border border-zinc-800 text-white p-4 focus:border-blue-500 outline-none font-serif text-lg pl-6" placeholder="Transmit signal..." />
                            <button type="submit" disabled={isProcessing} className="bg-blue-600 text-white px-8 font-bold text-xs hover:bg-blue-500 transition-all disabled:opacity-50">SEND</button>
                        </div>
                    </form>
                </main>
            </div>
        );
        
        if (phase === 'SUMMARY') return (
            <div className="min-h-screen bg-black text-white font-mono uppercase flex flex-col items-center justify-center p-8 text-center">
                <h1 className="text-8xl font-black italic tracking-tighter mb-8">{resolution >= 100 ? "SUCCESS" : "CRASH"}</h1>
                <p className="text-zinc-500 tracking-widest mb-12">RESERVE: {reserve}% | RESOLUTION: {resolution}%</p>
                <button onClick={() => window.location.reload()} className="bg-white text-black px-12 py-4 font-bold text-xl hover:bg-zinc-300">RESET</button>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
