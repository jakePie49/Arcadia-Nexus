<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFS v3.0: Social Turn Engine</title>
    
    <!-- React & Tailwind CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            background-color: #000;
            color: #e5e5e5;
            font-family: 'VT323', monospace;
            overflow: hidden; /* Prevent scroll on splash */
        }
        
        .pixel-font { font-family: 'Press Start 2P', cursive; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        
        /* Animation Utilities */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ==========================================
    // PART 1: CORE PHYSICS (INLINED)
    // ==========================================

    const TONE_COSTS = {
        NEUTRAL: 5, REASSURING: 12, APOLOGETIC: 18, 
        VULNERABLE: 28, DIRECT: 8, FIRM: 22, URGENT: 15
    };

    const DEFAULT_USER_HARDWARE = { gating: 50, context_pref: 15, rsd_sensitivity: 50 };

    const calculateTurnDrain = (params) => {
        const { user_hardware = DEFAULT_USER_HARDWARE, npc_dials, tone, env_static = 0, current_reserve = 100 } = params;
        
        // 1. Context Tax
        const contextDelta = Math.abs(user_hardware.context_pref - npc_dials.ctx) * 0.4;
        
        // 2. Sensory Load
        const gatingFriction = (100 - user_hardware.gating) * 0.2;
        const intensityLoad = (npc_dials.int * 0.15) + gatingFriction;
        
        // 3. Formality Tax
        const formalityTax = npc_dials.form * 0.1;

        // 4. Fatigue Multiplier
        const fatigueMultiplier = 1 + (100 - current_reserve) / 100;
        
        const baseTotal = TONE_COSTS[tone] + contextDelta + intensityLoad + formalityTax + (env_static / 4);
        const total = Math.round(baseTotal * fatigueMultiplier);

        return { 
            total, 
            breakdown: { 
                tone: TONE_COSTS[tone], 
                context: contextDelta, 
                intensity: intensityLoad, 
                static: (env_static/4), 
                fatigue: fatigueMultiplier 
            } 
        };
    };

    // ==========================================
    // PART 2: MANIFESTS
    // ==========================================

    const ARCHETYPES = {
        "SIGNAL_LOSS": { 
            "id": "SIGNAL_LOSS",
            "ctx": 10, "form": 5, "int": 95, "rsd": 30, 
            "voice": "Puck", "color": "text-yellow-400", "border": "border-yellow-500",
            "icon": "üìª", "desc": "MAX_AROUSAL | SENSORY_LEAK", 
            "hook": "OXY-LOW. WHY-STILL-LINKED? TETHER-STABLE. DO-NOT-DISCONNECT!" 
        },
        "ARCHIVE_V0": { 
            "id": "ARCHIVE_V0",
            "ctx": 95, "form": 95, "int": 20, "rsd": 80, 
            "voice": "Kore", "color": "text-purple-400", "border": "border-purple-500",
            "icon": "üëë", "desc": "MAX_FORMALITY | HIGH_CONTEXT", 
            "hook": "You approach the archive as if your presence is requested. Why do you disturb this equilibrium?" 
        },
        "STASIS_POINT": { 
            "id": "STASIS_POINT",
            "ctx": 90, "form": 80, "int": 15, "rsd": 95, 
            "voice": "Aoede", "color": "text-red-500", "border": "border-red-500",
            "icon": "üõ°Ô∏è", "desc": "MAX_RSD | SUBTEXT_VIGILANCE", 
            "hook": "The current vector is sufficient. A change would be... disruptive." 
        },
        "WASTE_RECOIL": { 
            "id": "WASTE_RECOIL",
            "ctx": 0, "form": 0, "int": 60, "rsd": 20, 
            "voice": "Fenrir", "color": "text-orange-400", "border": "border-orange-500",
            "icon": "üí®", "desc": "ZERO_FILTER | BRUTAL_LITERAL", 
            "hook": "You use too many words for someone with failing life support. Cut the line or drift." 
        }
    };

    const SCENARIOS = {
        "zero_g_heist": { 
            "id": "zero_g_heist", "title": "ZERO-G HEIST", 
            "context": "Oxygen at 4%. High-frequency alarms screaming.", 
            "static_load": 95, "map_color": "bg-slate-900" 
        },
        "neon_extraction": { 
            "id": "neon_extraction", "title": "NEON EXTRACTION", 
            "context": "Deafening club bass. Visual strobe interference.", 
            "static_load": 85, "map_color": "bg-fuchsia-950" 
        },
        "void_council": { 
            "id": "void_council", "title": "VOID COUNCIL", 
            "context": "Infinite white space. Silence.", 
            "static_load": 5, "map_color": "bg-zinc-950" 
        }
    };

    // ==========================================
    // PART 3: THE APP
    // ==========================================

    function App() {
        const [phase, setPhase] = useState('SPLASH'); 
        const [activeScenario, setActiveScenario] = useState(null);
        const [activeNpc, setActiveNpc] = useState(null);
        const [reserve, setReserve] = useState(100);
        const [resolution, setResolution] = useState(0); 
        const [chat, setChat] = useState([]);
        const [mathLog, setMathLog] = useState(null);
        const [isProcessing, setIsProcessing] = useState(false);
        const chatEndRef = useRef(null);

        useEffect(() => {
            if (chatEndRef.current) {
                chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
            }
        }, [chat]);

        const startSim = (npcKey, scenarioKey) => {
            setActiveNpc({...ARCHETYPES[npcKey]});
            setActiveScenario(SCENARIOS[scenarioKey]);
            setChat([{ role: 'npc', text: ARCHETYPES[npcKey].hook }]);
            setPhase('SIM');
            setReserve(100);
            setResolution(0);
            setMathLog(null);
        };

        const submitTurn = async (e) => {
            e.preventDefault();
            const text = e.target.userInput.value;
            const tone = e.target.tone.value;
            if (!text || isProcessing) return;
            setIsProcessing(true);
            e.target.userInput.value = "";

            // RUN THE PHYSICS ENGINE
            const result = calculateTurnDrain({
                npc_dials: activeNpc,
                tone: tone,
                env_static: activeScenario.static_load,
                current_reserve: reserve
            });
            
            setReserve(prev => Math.max(0, prev - result.total));
            setMathLog(result); 
            setChat(prev => [...prev, { role: 'user', text, tone, drain: result.total }]);

            // Simulated NPC Response
            setTimeout(() => {
                const responses = [
                    "Signal received. Processing impedance...",
                    "Your modulation is noted. Adjustment required.",
                    "Why did you phrase it like that?",
                    "Data accepted. Proceeding.",
                    "Wait. Repeat the vector."
                ];
                const reply = responses[Math.floor(Math.random() * responses.length)];

                setChat(prev => [...prev, { role: 'npc', text: reply }]);
                setResolution(prev => Math.min(100, prev + 20));
                setIsProcessing(false);
            }, 800);
        };

        if (phase === 'SPLASH') return (
            <div className="min-h-screen bg-black text-white font-mono uppercase flex flex-col items-center justify-center p-4">
                <h1 className="text-6xl md:text-8xl font-black italic text-blue-600 mb-8 tracking-tighter text-center">SFS_v3.0</h1>
                <p className="text-zinc-500 mb-12 text-xs md:text-sm tracking-widest">Consolidated Logic Preview</p>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-5xl">
                    <button onClick={() => startSim("SIGNAL_LOSS", "zero_g_heist")} className="p-8 border-2 border-green-500 bg-zinc-950 hover:bg-green-900/20 text-left transition-all group relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-30 text-4xl">üìª</div>
                        <h3 className="text-2xl font-black text-green-400 mb-2 italic">THE GLITCH</h3>
                        <p className="text-xs text-zinc-400 mb-4">Scenario: Zero-G Heist (95% Static)</p>
                        <div className="text-[0.6rem] bg-green-900/40 p-2 text-green-300 inline-block font-bold">TEST: SENSORY OVERLOAD</div>
                    </button>
                    
                    <button onClick={() => startSim("STASIS_POINT", "void_council")} className="p-8 border-2 border-red-500 bg-zinc-950 hover:bg-red-900/20 text-left transition-all group relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-30 text-4xl">üõ°Ô∏è</div>
                        <h3 className="text-2xl font-black text-red-400 mb-2 italic">THE FORTRESS</h3>
                        <p className="text-xs text-zinc-400 mb-4">Scenario: Void Council (5% Static)</p>
                        <div className="text-[0.6rem] bg-red-900/40 p-2 text-red-300 inline-block font-bold">TEST: SUBTEXT DECODING</div>
                    </button>
                </div>
            </div>
        );

        return (
            <div className="min-h-screen bg-black text-white font-mono uppercase flex flex-col md:flex-row">
                {/* HUD */}
                <div className="w-full md:w-80 border-b md:border-b-0 md:border-r border-zinc-800 p-6 flex flex-col bg-zinc-950/50">
                    <div className="mb-8">
                        <button onClick={() => setPhase('SPLASH')} className="text-xs text-zinc-600 underline mb-8 hover:text-white">EXIT_SIMULATION</button>
                        <p className="text-[0.6rem] text-zinc-500 tracking-widest mb-2 font-bold">REGULATION_RESERVE</p>
                        <div className="text-6xl font-black mb-2 tracking-tighter">{reserve}%</div>
                        <div className="h-2 bg-zinc-900 overflow-hidden border border-zinc-700">
                            <div className={`h-full transition-all duration-500 ${reserve < 20 ? 'bg-red-600' : 'bg-green-500'}`} style={{width: `${reserve}%`}}></div>
                        </div>
                    </div>
                    
                    {/* MATH LOG */}
                    <div className="flex-1 border-t-2 border-zinc-800 pt-8">
                        <p className="text-[0.7rem] text-blue-500 tracking-widest mb-4 flex items-center gap-2 font-bold">üßÆ DRAIN_CALCULATOR</p>
                        {mathLog ? (
                            <div className="space-y-3 text-[0.65rem] text-zinc-400 font-mono bg-black p-4 border border-zinc-800">
                                <div className="flex justify-between"><span>BASE_TONE_COST:</span><span className="text-white">{mathLog.breakdown.tone}</span></div>
                                <div className="flex justify-between"><span>CONTEXT_TAX:</span><span className="text-white">+{Math.round(mathLog.breakdown.context)}</span></div>
                                <div className="flex justify-between"><span>INTENSITY_LOAD:</span><span className="text-white">+{Math.round(mathLog.breakdown.intensity)}</span></div>
                                <div className="flex justify-between"><span>ENV_STATIC:</span><span className="text-white">+{Math.round(mathLog.breakdown.static)}</span></div>
                                <div className="border-t border-zinc-800 my-2"></div>
                                <div className="flex justify-between text-blue-400 font-bold"><span>FATIGUE_MULT:</span><span>x{mathLog.breakdown.fatigue.toFixed(2)}</span></div>
                                <div className="flex justify-between text-red-500 text-xl font-black mt-2"><span>TOTAL_DRAIN:</span><span>-{mathLog.total}</span></div>
                            </div>
                        ) : <p className="text-[0.6rem] text-zinc-700 italic">WAITING_FOR_INPUT...</p>}
                    </div>
                </div>

                {/* CHAT */}
                <main className="flex-1 flex flex-col relative h-[calc(100vh-320px)] md:h-screen">
                    <div className="absolute inset-0 pointer-events-none opacity-5 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
                    
                    <header className="p-6 border-b border-zinc-800 flex justify-between items-center z-10 bg-black/80 backdrop-blur">
                        <div className="flex items-center gap-4">
                            <div className={`p-2 border-2 ${activeNpc.border} rounded-full bg-black shadow-lg text-2xl`}>{activeNpc.icon}</div>
                            <div>
                                <h2 className={`text-2xl font-black ${activeNpc.color} italic tracking-tighter`}>{activeNpc.id}</h2>
                                <p className="text-[0.5rem] text-zinc-600 font-bold tracking-widest">{activeNpc.desc}</p>
                            </div>
                        </div>
                        <div className="text-right hidden md:block">
                            <p className="text-[0.6rem] text-zinc-500 font-bold tracking-widest">ENV_STATIC_LOAD</p>
                            <p className="text-xl font-bold text-white">{activeScenario.static_load}%</p>
                        </div>
                    </header>

                    <div className="flex-1 overflow-y-auto p-8 space-y-6 z-10 scroll-hide">
                        {chat.map((msg, i) => (
                            <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} fade-in`}>
                                <div className={`max-w-[85%] p-6 border-l-4 ${msg.role === 'user' ? 'bg-zinc-900 border-blue-600 text-right' : 'bg-zinc-950 border-zinc-700'}`}>
                                    <p className="text-lg normal-case font-serif text-zinc-300 leading-relaxed">{msg.text}</p>
                                    {msg.role === 'user' && <p className="text-[0.5rem] text-blue-500 mt-4 tracking-[0.2em] font-bold">TONE: {msg.tone} | DRAIN: {msg.drain}</p>}
                                </div>
                            </div>
                        ))}
                        <div ref={chatEndRef}></div>
                    </div>

                    <form onSubmit={submitTurn} className="p-6 bg-zinc-950 border-t border-zinc-800 z-10">
                        <div className="flex gap-4">
                            <select name="tone" className="bg-black border border-zinc-800 text-xs text-white p-4 w-32 md:w-40 focus:border-blue-500 outline-none font-bold">
                                {Object.keys(TONE_COSTS).map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                            <input name="userInput" autoComplete="off" className="flex-1 bg-black border border-zinc-800 text-white p-4 focus:border-blue-500 outline-none font-serif text-lg pl-6" placeholder="Transmit signal..." />
                            <button type="submit" disabled={isProcessing} className="bg-blue-600 text-white px-6 md:px-8 font-bold text-xs hover:bg-blue-500 transition-all disabled:opacity-50">SEND</button>
                        </div>
                    </form>
                </main>
            </div>
        );
    }
</script>
</body>
</html>
